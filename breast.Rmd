---
title: "Breast cancer"
author: "Mar Garcia-Aloy"
output: 
  html_document:
    toc: true
    number_sections: false
    toc_float: true
---

```{r startpoint, include = FALSE}
startpoint <- Sys.time()
```

# Descripción del ejemplo 

En este documento voy a aplicar los algoritmos DIABLO (del paquete `mixomics`), MFA (del paquete `FactorMineR`) y DIABLO (del paquete `mixOmics`) al conjunto de datos de demostración proporcionado por el algoritmo DIABLO del paquete `mixOmics`.  
Se trata de un conjutno de datos llamado `breast.TCGA` que contiene datos de la expresión o la abundancia de tres conjuntos de datos ómicos coincidentes: ARNm, ARNm y proteómica para 220 muestras de cáncer de mama (Basal, Her2, Luminal A). Los datos están dividos en 2 grupos llamados "training set" (n=150) y "test set" (n=70). Al conjunto de datos "test set" le falta el conjunto de datos de proteómica.


## Objetivo

El objetivo de este análisis de integración de datos ómicos es identificar una huella multiómica altamente correlacionada que discrimine los distintos subtipos de cáncer de mama “Basal”, “Her2” y “LumA”.  
Así pues, en primer lugar se va a proceder con la integración de los niveles de expresión de miRNA y mRNA y de la abundancia de proteínas mientras se intenta discriminar entre los subtipos de cáncer de mama con las muestras del grupo “training”, para luego predecir los subtipos en las muestras del grupo “test”.


# DIABLO (mixOmics)

```{r}
library(mixOmics)
data(breast.TCGA)
```

## Preparación de los datos

En primer lugar se extraen los datos ómicos del "training set" en un objeto llamado `X` y las categorías a las que pertenecen en el objeto `Y`.

```{r}
X <- list(mRNA = breast.TCGA$data.train$mrna, 
          miRNA = breast.TCGA$data.train$mirna, 
          protein = breast.TCGA$data.train$protein)
Y <- breast.TCGA$data.train$subtype
summary(Y)
```

## Número de variables a seleccionar por conjunto de datos y componente

```{r}
test.keepX = list(
  mrna = seq(10,40,20), mirna = seq(10,30,10), protein = seq(1,10,5))
set.seed(123)
tune = tune.block.splsda(
  X = X, Y = Y, ncomp = 2, test.keepX = test.keepX, 
  design = matrix(1, ncol = length(X), nrow = length(X), 
                  dimnames = list(names(X), names(X))), 
  nrepeat = 3)
tune$choice.keepX
tmp <- data.frame(tune$error.rate)
tmp[order(tmp$comp1, tmp$comp2),]
list.keepX <- list(mRNA = c(30, 30), miRNA = c(30, 30), protein = c(6,6))
```


## Ejecución del modelo

```{r}
res.diablo <- block.splsda(X = X, Y = Y, keepX = list.keepX, ncomp = 2, scale = TRUE, mode = "regression")
```

## Evaluación del modelo

### Capacidad de clasificar

```{r}
set.seed(123) # for reproducibility in this vignette
perf.diablo <- perf(res.diablo, validation = 'Mfold', folds = 5, 
                      nrepeat = 10, 
                      dist = 'centroids.dist')
perf.diablo$MajorityVote.error.rate
```

### AUC

```{r}
auroc(res.diablo, roc.block = "miRNA", roc.comp = 1)
auroc(res.diablo, roc.block = "miRNA", roc.comp = 2)
```

Parece ser que el primer componente consigue una buena separación de las muestras "Basal" y "LumA", pero no de las muestras "Her2", y auq el segundo componente consigue una buena separación de todas las 3 clases.

### Predicción usando un conjunto de muestras externas

```{r}
# prepare test set data: here one block (proteins) is missing
X.test <- list(mRNA = breast.TCGA$data.test$mrna, 
               miRNA = breast.TCGA$data.test$mirna)

predict.diablo <- predict(res.diablo, newdata = X.test)
confusion.mat <- get.confusion_matrix(
  truth = breast.TCGA$data.test$subtype, 
  predicted = predict.diablo$MajorityVote$centroids.dist[,2])
library(knitr)
kable(confusion.mat)
get.BER(confusion.mat)
```

En el conjunto de datos “test”, un “BER” del 16% estaría indicando una relativamente buena precisión de predicción para los subtipos de cáncer de mama.

## Muestras

```{r}
plotIndiv(res.diablo, blocks = "consensus", ellipse = TRUE)
```

En este caso, se observa como el primer componente separa principalmente las muestras "Basal" (azul) de las muestras "LumA" (gris), mientras que es el segundo componente separa las muestras "Her2" (naranja) del resto de muestras.

## Variables

```{r}
plotVar(res.diablo, 
        var.names = c(FALSE, FALSE, TRUE), 
        legend = TRUE, pch = c(16,16,1))
plotLoadings(res.diablo, comp = 1, contrib = "max")
plotLoadings(res.diablo, comp = 2, contrib = "max")
plotDiablo(res.diablo, ncomp = 1)
plotDiablo(res.diablo, ncomp = 2)
circosPlot(res.diablo, cutoff = 0.7)
jpeg(filename="breast_cim.jpeg")
cimDiablo(res.diablo, 
          color.blocks = c('darkorchid', 'brown1', 'lightgreen'), 
          comp = 1, margin = c(8,20), legend.position = "right")
dev.off()
network(res.diablo, blocks = c(1,2,3),
        color.node = c('darkorchid', 'brown1', 'lightgreen'), 
        cutoff = 0.7, save = 'jpeg', name.save = 'breast_network')
```
![](/Users/lenovo/Documents/GitHub/UOC_TFM_omicsintegration/breast_cim.jpeg)



# MFA (FactorMiner)

```{r}
library(FactoMineR)
library(factoextra)
```


# MCIA (omicade4)

# Session information

```{r session}
Sys.time()-startpoint
devtools::session_info()
```
